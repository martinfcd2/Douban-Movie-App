<template>
  <div
    class="moviebox"
    v-infinite-scroll="loadMore"
    infinite-scroll-disabled="loading"
    infinite-scroll-distance="10"
  >
    <div class="loading" v-if="!movies"></div>
    <MovieItem
      v-else
      v-for="movie in movies"
      :key="movie.id"
      :movie="movie"
    ></MovieItem>
  </div>
</template>

<script>
import MovieItem from "./MovieItem";
export default {
  components: { MovieItem },
  props: ["type"],
  data() {
    return {
      movies: [], //数组支持累加操作
      loading: false,
      limit: 6,
      page: 1,
      hasMore: true, //是否有更多数据，默认有更多数据
    };
  },
  watch: {
    // 类型：{ [key: string]: string | Function | Object | Array }
    // 一个对象，键是需要观察的state或者porps，值是对应回调函数。值也可以是方法名，或者包含选项的对象。
    // Vue 实例将会在实例化时调用 $watch()，遍历 watch 对象的每一个 property。
    type() {
      this.movies = [];
      this.page = 1; //切换的时候从第一页开始切换
      this.hasMore = true;
      this.getMovies();
    },
  },
  methods: {
    loadMore() {
      if (!this.hasMore) {
        this.$toast({
          message: "我是有底线的",
          position: "bottom",
          duration: 3000,
        });
        this.loading = true; //没有更多数据的时候关闭无限滚动，同时返回false，不执行接下来的操作
        return false;
      }
      this.getMovies();
    },
    getMovies() {
      //关闭无限滚动
      this.loading = true;
      const toast1 = this.$toast.loading({
        message: "加载中",
        duration: 0,
      });
      let { page, limit } = this;
      this.$http
        .get("/api/db/" + this.type, {
          params: {
            limit,
            page,
          },
        })
        .then((res) => {
          // this.movies = res.data.object_list

          //在原来的基础上拼接数组，并且返回新数组
          this.movies = this.movies.concat(res.data.object_list);
          //开启无限滚动
          this.loading = false;

          // instance.close();//关闭Toast提示框

          toast1.clear();
          if (this.limit * this.page >= res.data.total) {
            //判断是否有更多数据
            this.hasMore = false; //没有更多数据时将hasMore赋值为false，返回false，不执行接下来的page++
            return false;
          }
          this.page++;
        });
    },
  },
  activated() {
    this.loading = false; //继续开启无限滚动
  },
  //离开组件的时候执行
  deactivated() {
    this.loading = true; //关闭无限滚动
  },
};
</script>
<style>
.moviebox {
  /* top:94px; */
  position: relative;
  /* margin-bottom:40px; */
}
</style>